{% extends 'hotel/html/base.html' %}
{% load static %}

{% block title %}Book Room {{ room.room_number }} - MyHotel{% endblock %}

{% block content %}
<style>
  .booking-wrap { max-width: 1100px; margin: 0 auto; }
  .booking-card { border: 1px solid rgba(255,255,255,.08); border-radius: 14px; overflow: hidden; }
  .booking-head {
    background: linear-gradient(135deg, rgba(0,217,255,.18), rgba(0,0,0,.0));
    border-bottom: 1px solid rgba(255,255,255,.08);
    padding: 18px 20px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .booking-head h3 { margin:0; font-weight:700; letter-spacing:.2px; }
  .badge-soft {
    background: rgba(0,217,255,.14);
    color: #00d9ff;
    border: 1px solid rgba(0,217,255,.25);
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 12px;
  }
  .booking-body { padding: 20px; }
  .form-label { font-weight: 600; margin-bottom: 6px; }
  .form-control, select, textarea {
    border-radius: 12px !important;
    padding: 10px 12px !important;
    border: 1px solid rgba(255,255,255,.12) !important;
    background: rgba(255,255,255,.03) !important;
    color: inherit !important;
  }
  .help-text { font-size: 12px; opacity: .75; margin-top: 6px; }
  .summary-card { position: sticky; top: 18px; }
  .summary-row { display:flex; justify-content:space-between; gap:10px; margin: 10px 0; }
  .summary-total {
    border-top: 1px dashed rgba(255,255,255,.18);
    padding-top: 12px;
    margin-top: 12px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .big-total { font-size: 22px; font-weight: 800; }
  .btn-round { border-radius: 12px; padding: 10px 14px; }
</style>

<div class="booking-wrap">
  <div class="row g-4">
    <!-- LEFT: Form -->
    <div class="col-lg-8">
      <div class="card booking-card">
        <div class="booking-head">
          <div>
            <h3>Book Room {{ room.room_number }}</h3>
            <div class="text-muted" style="font-size:13px; margin-top:4px;">
              {{ room.category.category_name }} • Floor {{ room.floor }} • Max {{ room.max_occupancy }} guests
            </div>
          </div>
          <span class="badge-soft">Secure Booking</span>
        </div>

        <div class="card-body booking-body">
          <form method="POST" novalidate>
            {% csrf_token %}

            <div class="row g-3">
              {% for field in form %}
                <div class="col-md-6">
                  <label class="form-label">{{ field.label }}</label>
                  {{ field }}
                  {% if field.help_text %}
                    <div class="help-text">{{ field.help_text|safe }}</div>
                  {% endif %}
                  {% if field.errors %}
                    <div class="text-danger"><small>{{ field.errors }}</small></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary btn-round">
                Proceed to Payment
              </button>
              <a href="{% url 'room_list' %}" class="btn btn-outline-secondary btn-round">
                Cancel
              </a>
            </div>
          </form>

          <div class="mt-4 text-muted" style="font-size: 13px;">
            Tip: Choose your check-in and check-out dates to see total price instantly.
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Summary -->
    <div class="col-lg-4">
      <div class="card booking-card summary-card">
        <div class="booking-head">
          <h5 class="m-0" style="font-weight:800;">Booking Summary</h5>
          <span class="badge-soft">Room Details</span>
        </div>

        <div class="card-body booking-body">
          <div class="summary-row">
            <span class="text-muted">Room</span>
            <strong>#{{ room.room_number }}</strong>
          </div>

          <div class="summary-row">
            <span class="text-muted">Category</span>
            <strong>{{ room.category.category_name }}</strong>
          </div>

          <div class="summary-row">
            <span class="text-muted">Price / Night</span>
            <strong>$<span id="pricePerNight">{{ room.get_price }}</span></strong>
          </div>

          <div class="summary-row">
            <span class="text-muted">Nights</span>
            <strong><span id="nights">0</span></strong>
          </div>

          <div class="summary-total">
            <span class="text-muted">Estimated Total</span>
            <span class="big-total">$<span id="total">0.00</span></span>
          </div>

          <div class="mt-3 text-muted" style="font-size: 12px;">
            Total is based on nights × price/night. Services are added later (if any).
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    // Try common field names used in ReservationForm
    const checkIn =
      document.querySelector('input[name="check_in_date"]') ||
      document.querySelector('#id_check_in_date');

    const checkOut =
      document.querySelector('input[name="check_out_date"]') ||
      document.querySelector('#id_check_out_date');

    const priceEl = document.getElementById('pricePerNight');
    const nightsEl = document.getElementById('nights');
    const totalEl = document.getElementById('total');

    const pricePerNight = parseFloat((priceEl?.textContent || "0").replace(/[^0-9.]/g,'')) || 0;

    function toDate(val) {
      // expected yyyy-mm-dd
      if (!val) return null;
      const d = new Date(val + 'T00:00:00');
      return isNaN(d.getTime()) ? null : d;
    }

    function calc() {
      const inD = toDate(checkIn?.value);
      const outD = toDate(checkOut?.value);

      if (!inD || !outD) {
        nightsEl.textContent = "0";
        totalEl.textContent = "0.00";
        return;
      }

      const diff = Math.ceil((outD - inD) / (1000 * 60 * 60 * 24));
      const nights = Math.max(diff, 0);

      nightsEl.textContent = String(nights);
      const total = nights * pricePerNight;
      totalEl.textContent = total.toFixed(2);
    }

    if (checkIn) checkIn.addEventListener('change', calc);
    if (checkOut) checkOut.addEventListener('change', calc);
    calc();
  })();
</script>
{% endblock %}
