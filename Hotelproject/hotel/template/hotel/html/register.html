{% extends 'hotel/html/base.html' %}

{% block title %}Register - MyHotel{% endblock %}

{% block content %}

<div class="register-container">
    <h2>Create an Account</h2>

    {% if messages %}
        {% for message in messages %}
            {% if 'success' in message.tags or 'info' in message.tags %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endif %}
        {% endfor %}
    {% endif %}

    <form method="POST" novalidate>
        {% csrf_token %}
        {% if csrf_token_value %}
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token_value }}">
        {% endif %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="mb-3">
            {{ form.username.label_tag }}
            {{ form.username }}
            {% if form.username.errors %}
                <div class="text-danger">{{ form.username.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.email.label_tag }}
            {{ form.email }}
            {% if form.email.errors %}
                <div class="text-danger">{{ form.email.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.password1.label_tag }}
            {{ form.password1 }}
            {% if form.password1.errors %}
                <div class="text-danger">{{ form.password1.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.password2.label_tag }}
            {{ form.password2 }}
            {% if form.password2.errors %}
                <div class="text-danger">{{ form.password2.errors }}</div>
            {% endif %}
        </div>

        <hr>

        {% if guest_form.non_field_errors %}
            <div class="alert alert-danger">{{ guest_form.non_field_errors }}</div>
        {% endif %}

        <div class="mb-3">
            {{ form.first_name.label_tag }}
            {{ form.first_name }}
            {% if form.first_name.errors %}
                <div class="text-danger">{{ form.first_name.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ form.last_name.label_tag }}
            {{ form.last_name }}
            {% if form.last_name.errors %}
                <div class="text-danger">{{ form.last_name.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ guest_form.phone.label_tag }}
            {{ guest_form.phone }}
            {% if guest_form.phone.errors %}
                <div class="text-danger">{{ guest_form.phone.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            {{ guest_form.address.label_tag }}
            {{ guest_form.address }}
            {% if guest_form.address.errors %}
                <div class="text-danger">{{ guest_form.address.errors }}</div>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-primary">Register</button>
    </form>

    <p class="login-link">
        Already have an account? <a href="{% url 'login' %}">Login</a>
    </p>
</div>

<script>
// Ensure CSRF token is sent even if cookie/token mismatch occurs in some dev browsers.
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (!form) return;
    form.addEventListener('submit', function() {
        const existing = form.querySelector('input[name="csrfmiddlewaretoken"]');
        if (!existing) {
            const token = getCookie('csrftoken');
            if (token) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrfmiddlewaretoken';
                input.value = token;
                form.appendChild(input);
            }
        }
    });
});
</script>

{% endblock %}
