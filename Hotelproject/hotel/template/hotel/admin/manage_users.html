{% extends 'hotel/admin/admin_base.html' %}
{% block title %}Manage Users - Admin Panel{% endblock %}

{% block admin_content %}
<style>
  :root {
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #0ea5e9;
    --purple: #8b5cf6;
    --muted: #64748b;
    --border: #e2e8f0;
    --bg-soft: #f8fafc;
  }

  .page-head{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:14px;
    margin-bottom:24px;
    flex-wrap:wrap;
  }
  .page-head h2{
    margin:0;
    font-weight:900;
    font-size:28px;
    color:#0f172a;
  }
  .page-sub{
    margin:6px 0 0;
    color:var(--muted);
    font-weight:600;
    font-size:14px;
  }

  /* Alert Enhancements */
  .alert{
    border-radius:12px;
    border:none;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    margin-bottom:24px;
    padding:16px 20px;
    display:flex;
    align-items:center;
    gap:12px;
  }
  .alert-success{
    background:#d1fae5;
    color:#065f46;
    border-left:4px solid #22c55e;
  }
  .alert-danger{
    background:#fee2e2;
    color:#991b1b;
    border-left:4px solid #ef4444;
  }
  .alert-warning{
    background:#fef3c7;
    color:#92400e;
    border-left:4px solid #f59e0b;
  }
  .alert-info{
    background:#dbeafe;
    color:#1e3a8a;
    border-left:4px solid #3b82f6;
  }

  /* Statistics Cards */
  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    gap:16px;
    margin-bottom:24px;
  }
  .stat-card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:12px;
    padding:18px 20px;
    display:flex;
    align-items:center;
    gap:14px;
    transition:all 0.2s ease;
  }
  .stat-card:hover{
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    transform:translateY(-2px);
  }
  .stat-icon{
    width:48px;
    height:48px;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    flex-shrink:0;
  }
  .stat-icon.blue{ background:#dbeafe; color:#2563eb; }
  .stat-icon.green{ background:#dcfce7; color:#16a34a; }
  .stat-icon.orange{ background:#fed7aa; color:#ea580c; }
  .stat-icon.purple{ background:#ede9fe; color:#7c3aed; }
  .stat-icon.pink{ background:#fce7f3; color:#db2777; }

  .stat-details{ flex:1; }
  .stat-label{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-bottom:4px;
  }
  .stat-value{
    font-size:24px;
    font-weight:900;
    color:#0f172a;
  }

  /* Toolbar */
  .toolbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:16px;
    margin-bottom:24px;
    flex-wrap:wrap;
  }

  .toolbar-left{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
    flex:1;
  }

  .search{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 14px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fff;
    min-width:280px;
    transition:all 0.2s ease;
  }
  .search:focus-within{
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(59,130,246,0.1);
  }
  .search input{
    border:none;
    outline:none;
    background:transparent;
    width:100%;
    font-weight:600;
    color:#0f172a;
    font-size:14px;
  }
  .search input::placeholder{ color:#94a3b8; }

  /* Filter Buttons */
  .filter-group{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .filter-btn{
    padding:8px 16px;
    border:1px solid var(--border);
    border-radius:8px;
    background:#fff;
    font-weight:700;
    font-size:13px;
    color:var(--muted);
    cursor:pointer;
    transition:all 0.2s ease;
    white-space:nowrap;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .filter-btn:hover{
    background:var(--bg-soft);
    border-color:#cbd5e1;
  }
  .filter-btn.active{
    background:var(--primary);
    color:#fff;
    border-color:var(--primary);
  }

  /* Action Button */
  .btn-action{
    padding:12px 24px;
    border:none;
    border-radius:10px;
    background:var(--primary);
    color:#fff;
    font-weight:700;
    font-size:14px;
    cursor:pointer;
    transition:all 0.2s ease;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .btn-action:hover{
    background:var(--primary-dark);
    box-shadow:0 4px 12px rgba(59,130,246,0.3);
  }

  /* Main Card */
  .admin-card{
    background:#fff;
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow:0 1px 3px rgba(0,0,0,0.05);
    overflow:hidden;
  }

  /* Table */
  .table-wrapper{ overflow-x:auto; }
  .admin-table{
    width:100%;
    border-collapse:collapse;
  }
  .admin-table thead th{
    text-align:left;
    color:var(--muted);
    font-weight:800;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.5px;
    padding:16px 20px;
    background:var(--bg-soft);
    border-bottom:2px solid var(--border);
    white-space:nowrap;
  }
  .admin-table tbody td{
    padding:16px 20px;
    border-top:1px solid #f1f5f9;
    vertical-align:middle;
    font-weight:700;
    color:#0f172a;
    font-size:14px;
  }
  .admin-table tbody tr{ transition:all 0.15s ease; }
  .admin-table tbody tr:hover{ background:#f8fafc; }

  /* User Info */
  .user-info{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .user-avatar{
    width:40px;
    height:40px;
    border-radius:50%;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:900;
    font-size:16px;
    flex-shrink:0;
  }
  .user-details{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .user-name{
    font-weight:800;
    color:#0f172a;
    font-size:15px;
  }
  .user-email{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
  }

  /* Badges */
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 12px;
    border-radius:8px;
    font-weight:800;
    font-size:12px;
  }
  .badge-admin{ background:#ede9fe; color:#5b21b6; }
  .badge-staff{ background:#dbeafe; color:#1e3a8a; }
  .badge-customer{ background:#f0fdf4; color:#166534; }
  .badge-receptionist{ background:#fef3c7; color:#92400e; }
  .badge-yes{ background:#d1fae5; color:#065f46; }
  .badge-no{ background:#f1f5f9; color:#64748b; }

  /* Action Buttons */
  .action-btns{
    display:flex;
    gap:8px;
  }
  .btn-sm{
    padding:8px 14px;
    border-radius:8px;
    font-weight:700;
    font-size:13px;
    cursor:pointer;
    transition:all 0.2s ease;
    display:flex;
    align-items:center;
    gap:6px;
    border:none;
  }
  .btn-primary{
    background:var(--primary);
    color:#fff;
  }
  .btn-primary:hover{
    background:var(--primary-dark);
    box-shadow:0 2px 8px rgba(59,130,246,0.3);
  }
  .btn-danger{
    background:var(--danger);
    color:#fff;
  }
  .btn-danger:hover{
    background:#dc2626;
    box-shadow:0 2px 8px rgba(239,68,68,0.3);
  }
  .btn-secondary{
    background:#6b7280;
    color:#fff;
  }
  .btn-secondary:hover{ background:#4b5563; }

  /* Empty State */
  .empty{
    padding:60px 24px;
    text-align:center;
  }
  .empty-icon{
    font-size:64px;
    color:#cbd5e1;
    margin-bottom:16px;
  }
  .empty-text{
    color:var(--muted);
    font-weight:700;
    font-size:16px;
  }

  /* Modal Enhancements */
  .modal-content{
    border-radius:16px;
    border:none;
    box-shadow:0 20px 60px rgba(0,0,0,0.2);
  }
  .modal-header{
    background:var(--bg-soft);
    border-bottom:1px solid var(--border);
    padding:20px 24px;
  }
  .modal-title{
    font-weight:900;
    color:#0f172a;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .modal-body{ padding:24px; }
  .modal-footer{
    background:var(--bg-soft);
    border-top:1px solid var(--border);
    padding:16px 24px;
  }

  .form-label{
    font-weight:700;
    color:#0f172a;
    margin-bottom:8px;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .form-control{
    border:1px solid var(--border);
    border-radius:8px;
    padding:10px 14px;
    font-weight:600;
    transition:all 0.2s ease;
  }
  .form-control:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(59,130,246,0.1);
    outline:none;
  }
  .form-control:disabled{
    background:#f8fafc;
    color:#94a3b8;
  }

  .form-check-input{
    width:20px;
    height:20px;
    border:2px solid var(--border);
    border-radius:4px;
    cursor:pointer;
  }
  .form-check-input:checked{
    background:var(--primary);
    border-color:var(--primary);
  }
  .form-check-label{
    font-weight:700;
    color:#0f172a;
    margin-left:8px;
    cursor:pointer;
  }

  /* Summary Bar */
  .summary-bar{
    padding:16px 24px;
    border-bottom:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#f8fafc;
    flex-wrap:wrap;
    gap:12px;
  }
  .summary-item{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
  }
  .summary-label{
    color:var(--muted);
    font-weight:700;
  }
  .summary-value{
    font-weight:900;
    color:#0f172a;
  }

  /* Responsive */
  @media (max-width: 768px){
    .page-head{ flex-direction:column; align-items:flex-start; }
    .toolbar{ flex-direction:column; align-items:stretch; }
    .toolbar-left{ flex-direction:column; }
    .search{ width:100%; }
    .stats-grid{ grid-template-columns:1fr; }
    .action-btns{ flex-direction:column; }
  }
</style>

<div class="page-head">
  <div>
    <h2>User Management</h2>
    <p class="page-sub">Manage system users, roles, and permissions</p>
  </div>

  <button class="btn-action" data-bs-toggle="modal" data-bs-target="#addUserModal">
    <i class="fas fa-user-plus"></i>
    Add New User
  </button>
</div>


<!-- Statistics Overview -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon blue">
      <i class="fas fa-users"></i>
    </div>
    <div class="stat-details">
      <div class="stat-label">Total Users</div>
      <div class="stat-value"><span id="totalUsers">{{ users|length }}</span></div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon green">
      <i class="fas fa-user-shield"></i>
    </div>
    <div class="stat-details">
      <div class="stat-label">Staff Members</div>
      <div class="stat-value"><span id="staffCount">0</span></div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon purple">
      <i class="fas fa-crown"></i>
    </div>
    <div class="stat-details">
      <div class="stat-label">Superusers</div>
      <div class="stat-value"><span id="superuserCount">0</span></div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon orange">
      <i class="fas fa-user-friends"></i>
    </div>
    <div class="stat-details">
      <div class="stat-label">Customers</div>
      <div class="stat-value"><span id="customerCount">0</span></div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon pink">
      <i class="fas fa-user-tag"></i>
    </div>
    <div class="stat-details">
      <div class="stat-label">Admins</div>
      <div class="stat-value"><span id="adminCount">0</span></div>
    </div>
  </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <div class="toolbar-left">
    <div class="search">
      <i class="fas fa-search"></i>
      <input id="searchInput" type="text" placeholder="Search by username or email..." onkeyup="filterUsers()">
    </div>

    <div class="filter-group">
      <button class="filter-btn active" onclick="filterByRole('all')">
        All Users
      </button>
      <button class="filter-btn" onclick="filterByRole('Admin')">
        <i class="fas fa-user-shield"></i> Admins
      </button>
      <button class="filter-btn" onclick="filterByRole('Staff')">
        <i class="fas fa-users-cog"></i> Staff
      </button>
      <button class="filter-btn" onclick="filterByRole('Receptionist')">
        <i class="fas fa-user-tie"></i> Receptionists
      </button>
      <button class="filter-btn" onclick="filterByRole('Customer')">
        <i class="fas fa-user"></i> Customers
      </button>
    </div>
  </div>
</div>

<div class="admin-card">
  {% if users %}
    <div class="summary-bar">
      <div class="summary-item">
        <span class="summary-label">Showing:</span>
        <span class="summary-value" id="visibleCount">{{ users|length }}</span>
        <span class="summary-label">of {{ users|length }} users</span>
      </div>
    </div>

    <div class="table-wrapper">
      <table class="admin-table" id="usersTable">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Staff Status</th>
            <th>Superuser</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
            <tr data-role="{{ u.userprofile.role|default:'Customer' }}" data-is-staff="{{ u.is_staff }}" data-is-superuser="{{ u.is_superuser }}">
              <td>
                <div class="user-info">
                  <div class="user-avatar">
                    {{ u.username|first|upper }}
                  </div>
                  <div class="user-details">
                    <div class="user-name">{{ u.username }}</div>
                    <div class="user-email">{{ u.email|default:"No email" }}</div>
                  </div>
                </div>
              </td>

              <td>
                {% if u.userprofile.role == 'Admin' %}
                  <span class="badge badge-admin"><i class="fas fa-shield-alt"></i> Admin</span>
                {% elif u.userprofile.role == 'Staff' %}
                  <span class="badge badge-staff"><i class="fas fa-users-cog"></i> Staff</span>
                {% elif u.userprofile.role == 'Receptionist' %}
                  <span class="badge badge-receptionist"><i class="fas fa-user-tie"></i> Receptionist</span>
                {% else %}
                  <span class="badge badge-customer"><i class="fas fa-user"></i> Customer</span>
                {% endif %}
              </td>

              <td>
                {% if u.is_staff %}
                  <span class="badge badge-yes"><i class="fas fa-check"></i> Staff</span>
                {% else %}
                  <span class="badge badge-no"><i class="fas fa-times"></i> Regular</span>
                {% endif %}
              </td>

              <td>
                {% if u.is_superuser %}
                  <span class="badge badge-yes"><i class="fas fa-crown"></i> Yes</span>
                {% else %}
                  <span class="badge badge-no"><i class="fas fa-user"></i> No</span>
                {% endif %}
              </td>

              <td>
                <div class="action-btns">
                  <button type="button" class="btn btn-sm btn-primary"
                    data-bs-toggle="modal" data-bs-target="#editUserModal"
                    data-user-id="{{ u.id }}"
                    data-username="{{ u.username }}"
                    data-email="{{ u.email }}"
                    data-role="{{ u.userprofile.role|default:'Customer' }}"
                    data-is-staff="{{ u.is_staff|lower }}"
                    data-is-superuser="{{ u.is_superuser|lower }}"
                    onclick="editUser(this)">
                    <i class="fas fa-edit"></i> Edit
                  </button>

                  <!-- SweetAlert delete -->
                  <form method="post"
                        action="{% url 'delete_user' u.id %}"
                        data-swal="delete"
                        data-swal-name="user {{ u.username }}"
                        style="display:inline;margin:0;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty">
      <div class="empty-icon"><i class="fas fa-users"></i></div>
      <div class="empty-text">No users found</div>
    </div>
  {% endif %}
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">
          <i class="fas fa-user-plus" style="color:var(--primary);"></i>
          Add New User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- SweetAlert create -->
      <form method="post" action="{% url 'add_user' %}" data-swal="create">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-user"></i> Username *</label>
            <input type="text" name="username" class="form-control" placeholder="Enter username" required>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
            <input type="email" name="email" class="form-control" placeholder="user@example.com">
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-lock"></i> Password *</label>
            <input type="password" name="password" class="form-control" placeholder="Enter secure password" required>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-briefcase"></i> Role</label>
            <select name="role" class="form-control">
              <option value="Customer">Customer</option>
              <option value="Staff">Staff</option>
              <option value="Receptionist">Receptionist</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" name="is_staff" class="form-check-input" id="addIsStaff">
            <label class="form-check-label" for="addIsStaff">
              <i class="fas fa-shield-alt" style="color:var(--success);"></i>
              Grant Staff Privileges
            </label>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" name="is_superuser" class="form-check-input" id="addIsSuperuser">
            <label class="form-check-label" for="addIsSuperuser">
              <i class="fas fa-crown" style="color:var(--warning);"></i>
              Grant Superuser Privileges
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Create User
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">
          <i class="fas fa-user-edit" style="color:var(--warning);"></i>
          Edit User
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- SweetAlert save -->
      <form method="post" id="editUserForm" action="" data-swal="save">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-user"></i> Username</label>
            <input type="text" id="editUsername" class="form-control" disabled>
            <small class="text-muted">Username cannot be changed</small>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
            <input type="email" id="editEmail" class="form-control" disabled>
            <small class="text-muted">Email cannot be changed</small>
          </div>

          <div class="mb-3">
            <label class="form-label"><i class="fas fa-briefcase"></i> Role</label>
            <select name="role" id="editRole" class="form-control">
              <option value="Customer">Customer</option>
              <option value="Staff">Staff</option>
              <option value="Receptionist">Receptionist</option>
              <option value="Admin">Admin</option>
            </select>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" name="is_staff" id="editIsStaff" class="form-check-input">
            <label class="form-check-label" for="editIsStaff">
              <i class="fas fa-shield-alt" style="color:var(--success);"></i>
              Staff Privileges
            </label>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" name="is_superuser" id="editIsSuperuser" class="form-check-input">
            <label class="form-check-label" for="editIsSuperuser">
              <i class="fas fa-crown" style="color:var(--warning);"></i>
              Superuser Privileges
            </label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let currentFilter = 'all';

  function calculateStats() {
    const rows = document.querySelectorAll('#usersTable tbody tr');
    let staffCount = 0;
    let superuserCount = 0;
    let customerCount = 0;
    let adminCount = 0;

    rows.forEach(row => {
      const isStaff = row.getAttribute('data-is-staff') === 'True';
      const isSuperuser = row.getAttribute('data-is-superuser') === 'True';
      const role = row.getAttribute('data-role');

      if (isStaff) staffCount++;
      if (isSuperuser) superuserCount++;
      if (role === 'Customer') customerCount++;
      if (role === 'Admin') adminCount++;
    });

    document.getElementById('staffCount').textContent = staffCount;
    document.getElementById('superuserCount').textContent = superuserCount;
    document.getElementById('customerCount').textContent = customerCount;
    document.getElementById('adminCount').textContent = adminCount;
  }

  function filterByRole(role) {
    currentFilter = role;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.filter-btn').classList.add('active');
    filterUsers();
  }

  function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
      const username = row.querySelector('.user-name').textContent.toLowerCase();
      const email = row.querySelector('.user-email').textContent.toLowerCase();
      const role = row.getAttribute('data-role');

      const matchesSearch = username.includes(searchTerm) || email.includes(searchTerm);
      const matchesFilter = currentFilter === 'all' || role === currentFilter;

      const shouldShow = matchesSearch && matchesFilter;
      row.style.display = shouldShow ? '' : 'none';
      if (shouldShow) visibleCount++;
    });

    document.getElementById('visibleCount').textContent = visibleCount;
  }

  function editUser(button) {
    const userId = button.getAttribute('data-user-id');
    const username = button.getAttribute('data-username');
    const email = button.getAttribute('data-email');
    const role = button.getAttribute('data-role');
    const isStaff = button.getAttribute('data-is-staff') === 'true';
    const isSuperuser = button.getAttribute('data-is-superuser') === 'true';

    document.getElementById('editUsername').value = username;
    document.getElementById('editEmail').value = email;
    document.getElementById('editRole').value = role;
    document.getElementById('editIsStaff').checked = isStaff;
    document.getElementById('editIsSuperuser').checked = isSuperuser;

    const editUrl = '/dashboard/users/' + userId + '/edit/';
    document.getElementById('editUserForm').action = editUrl;
  }

  document.addEventListener('DOMContentLoaded', function() {
    calculateStats();
  });
</script>

{% endblock %}
