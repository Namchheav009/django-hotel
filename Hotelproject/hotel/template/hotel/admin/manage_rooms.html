{% extends 'hotel/admin/admin_base.html' %}
{% load static %}

{% block title %}Manage Rooms - Admin Panel{% endblock %}
{% block page_title %}Rooms{% endblock %}
{% block page_subtitle %}Create, edit and manage all rooms{% endblock %}

{% block extra_head %}
<style>
  /* Table */
  .admin-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
  }
  .admin-table thead th{
    text-align:left;
    font-size:13px;
    color:var(--muted);
    font-weight:1000;
    padding:12px 10px;
    border-bottom:1px solid var(--line);
  }
  .admin-table tbody td{
    padding:14px 10px;
    border-bottom:1px solid var(--line);
    vertical-align:middle;
    font-weight:900;
  }
  .admin-table tbody tr:hover{
    background:#fbfcff;
  }

  .room-cell{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .room-thumb{
    width:52px;height:42px;border-radius:14px;
    border:1px solid var(--line);
    background:#f2f5fb;
    overflow:hidden;
    flex:0 0 auto;
  }
  .room-thumb img{
    width:100%;height:100%;
    object-fit:cover;
    display:block;
  }
  .room-title{
    font-weight:1000;
    color:var(--text);
    margin:0;
    line-height:1.1;
  }
  .room-sub{
    margin:4px 0 0;
    font-weight:900;
    color:var(--muted);
    font-size:13px;
  }

  /* Status badges */
  .badge-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-weight:1000;
    font-size:13px;
  }
  .dot{ width:8px;height:8px;border-radius:999px;background:#94a3b8; }
  .st-available{ background:#e9fff3; border-color:#b7f3d0; color:#0b1220; }
  .st-available .dot{ background:#22c55e; }
  .st-booked{ background:#fff7ed; border-color:#fed7aa; color:#0b1220; }
  .st-booked .dot{ background:#f59e0b; }
  .st-maint{ background:#fef2f2; border-color:#fecaca; color:#0b1220; }
  .st-maint .dot{ background:#ef4444; }

  /* Header actions row */
  .rooms-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:14px;
  }
  .rooms-actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .btnx{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:10px 12px;
    border-radius:14px;
    font-weight:1000;
    text-decoration:none;
    border:1px solid var(--line);
    background:#fff;
    color:#111827;
    transition:.15s ease;
  }
  .btnx:hover{ transform: translateY(-2px); box-shadow: 0 10px 24px rgba(11,18,32,.08); }

  .btnx-dark{
    background:linear-gradient(180deg,#0f2133,#0c1a2a);
    border-color:transparent;
    color:#fff;
  }
  .btnx-dark:hover{ color:#fff; }

  .btnx-danger{
    background:#fff;
    border-color:#fecaca;
    color:#b91c1c;
  }

  .muted{ color:var(--muted); font-weight:900; }

  /* Modal */
  .modal-content{
    border-radius:18px;
    border:1px solid var(--line);
    box-shadow: var(--shadow);
  }
  .modal-header{
    border-bottom:1px solid var(--line);
  }
  .modal-footer{
    border-top:1px solid var(--line);
  }

  @media(max-width: 900px){
    .rooms-head{ flex-direction:column; align-items:flex-start; }
  }
</style>
{% endblock %}

{% block admin_content %}

<div class="rooms-head">
  <div>
    <h3 style="margin:0;font-weight:1000;">Room Management</h3>
    <div class="muted" style="margin-top:4px;">Total: {{ rooms|length }}</div>
  </div>

  <div class="rooms-actions">
    <button class="btnx btnx-dark" data-bs-toggle="modal" data-bs-target="#addRoomModal">
      <i class="fa-solid fa-plus"></i> Add New Room
    </button>
  </div>
</div>

<div class="admin-card">
  {% if rooms %}
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Room</th>
            <th>Floor</th>
            <th>Status</th>
            <th>Occupancy</th>
            <th>Price</th>
            <th style="min-width:180px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for room in rooms %}
          <tr>
            <td>
              <div class="room-cell">
                <div class="room-thumb">
                  {% if room.image %}
                    <img src="{{ room.image.url }}" alt="Room image">
                  {% else %}
                    <img src="{% static 'hotel/img/hero.png' %}" alt="Room image">
                  {% endif %}
                </div>
                <div>
                  <p class="room-title">Room {{ room.room_number }}</p>
                  <p class="room-sub">{{ room.category.category_name }}</p>
                </div>
              </div>
            </td>

            <td class="muted">{{ room.floor }}</td>

            <td>
              {% if room.status == 'Available' %}
                <span class="badge-pill st-available"><span class="dot"></span> Available</span>
              {% elif room.status == 'Booked' %}
                <span class="badge-pill st-booked"><span class="dot"></span> Booked</span>
              {% else %}
                <span class="badge-pill st-maint"><span class="dot"></span> Maintenance</span>
              {% endif %}
            </td>

            <td class="muted">{{ room.max_occupancy }} persons</td>

            <td class="muted">
              {% if room.price %}
                ${{ room.price }}
              {% else %}
                <span class="muted">Use category price</span>
              {% endif %}
            </td>

            <td>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editRoomModal{{ room.id }}">
                  <i class="fa-solid fa-pen"></i> Edit
                </button>

                <form method="POST" action="{% url 'delete_room' room.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-danger" onclick="return confirm('Delete room {{ room.room_number }}?');">
                    <i class="fa-solid fa-trash"></i> Delete
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center muted" style="padding:18px;">
      No rooms available.
    </div>
  {% endif %}
</div>

<!-- ✅ Add Room Modal -->
<div class="modal fade" id="addRoomModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <div>
          <h5 class="modal-title" style="font-weight:1000;margin:0;">Add New Room</h5>
          <div class="muted" style="font-size:13px;margin-top:4px;">Create a room with optional image.</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- ✅ IMPORTANT: enctype for image upload -->
      <form method="POST" action="{% url 'add_room' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Room Number</label>
              <input type="text" class="form-control" name="room_number" placeholder="e.g. 304" required>
            </div>

            <div class="col-md-8">
              <label class="form-label" style="font-weight:1000;">Category</label>
              <select class="form-select" name="category" required>
                <option value="">Select Category</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.category_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Floor</label>
              <input type="number" class="form-control" name="floor" value="1" min="1" required>
            </div>

            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Max Occupancy</label>
              <input type="number" class="form-control" name="max_occupancy" value="2" min="1" required>
            </div>

            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Status</label>
              <select class="form-select" name="status">
                <option value="Available">Available</option>
                <option value="Booked">Booked</option>
                <option value="Maintenance">Maintenance</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label" style="font-weight:1000;">Room Price (optional)</label>
              <input type="number" step="0.01" class="form-control" name="price" placeholder="Leave blank to use category price">
            </div>

            <div class="col-md-6">
              <label class="form-label" style="font-weight:1000;">Room Image</label>
              <input type="file" class="form-control" name="image" accept="image/*">
              <div class="muted" style="font-size:12px;margin-top:6px;">
                Tip: make sure you configured MEDIA_URL + MEDIA_ROOT.
              </div>
            </div>

            <div class="col-12">
              <label class="form-label" style="font-weight:1000;">Description</label>
              <textarea class="form-control" name="description" rows="3" placeholder="Room details..."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label" style="font-weight:1000;">Amenities (comma separated)</label>
              <input type="text" class="form-control" name="amenities" placeholder="WiFi, AC, TV">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary" style="font-weight:1000;">
            <i class="fa-solid fa-check"></i> Add Room
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- ✅ Edit Room Modal (one for each room) -->
{% for room in rooms %}
<div class="modal fade" id="editRoomModal{{ room.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <div>
          <h5 class="modal-title" style="font-weight:1000;margin:0;">Edit Room {{ room.room_number }}</h5>
          <div class="muted" style="font-size:13px;margin-top:4px;">Update room details and image.</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="POST" action="{% url 'edit_room' room.id %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Room Number</label>
              <input type="text" class="form-control" name="room_number" value="{{ room.room_number }}" required>
            </div>

            <div class="col-md-8">
              <label class="form-label" style="font-weight:1000;">Category</label>
              <select class="form-select" name="category" required>
                <option value="">Select Category</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {% if cat.id == room.category.id %}selected{% endif %}>{{ cat.category_name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Floor</label>
              <input type="number" class="form-control" name="floor" value="{{ room.floor }}" min="1" required>
            </div>

            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Max Occupancy</label>
              <input type="number" class="form-control" name="max_occupancy" value="{{ room.max_occupancy }}" min="1" required>
            </div>

            <div class="col-md-4">
              <label class="form-label" style="font-weight:1000;">Status</label>
              <select class="form-select" name="status">
                <option value="Available" {% if room.status == 'Available' %}selected{% endif %}>Available</option>
                <option value="Booked" {% if room.status == 'Booked' %}selected{% endif %}>Booked</option>
                <option value="Maintenance" {% if room.status == 'Maintenance' %}selected{% endif %}>Maintenance</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label" style="font-weight:1000;">Room Price (optional)</label>
              <input type="number" step="0.01" class="form-control" name="price" value="{% if room.price %}{{ room.price }}{% endif %}" placeholder="Leave blank to use category price">
            </div>

            <div class="col-md-6">
              <label class="form-label" style="font-weight:1000;">Room Image</label>
              <input type="file" class="form-control" name="image" accept="image/*">
              {% if room.image %}
                <div class="muted" style="font-size:12px;margin-top:6px;">
                  Current: <a href="{{ room.image.url }}" target="_blank">View image</a>
                </div>
              {% endif %}
            </div>

            <div class="col-12">
              <label class="form-label" style="font-weight:1000;">Description</label>
              <textarea class="form-control" name="description" rows="3" placeholder="Room details...">{{ room.description }}</textarea>
            </div>

            <div class="col-12">
              <label class="form-label" style="font-weight:1000;">Amenities (comma separated)</label>
              <input type="text" class="form-control" name="amenities" value="{{ room.amenities }}" placeholder="WiFi, AC, TV">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" style="font-weight:1000;">
            <i class="fa-solid fa-save"></i> Save Changes
          </button>
        </div>
      </form>

    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
