{% extends 'hotel/admin/admin_base.html' %}

{% block admin_content %}
<div class="page-head">
  <div>
    <h2>Service Bookings</h2>
    <p class="page-sub">Manage all service bookings</p>
  </div>
</div>

<div class="cardx">
  <div class="cardx-top">
    <div class="tools">
      <div class="search">
        <i class="fas fa-search"></i>
        <input id="q" type="text" placeholder="Search guest or service..." oninput="filterTable()">
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    {% if bookings %}
    <table id="serviceBookingsTable">
      <thead>
        <tr>
          <th>Guest</th>
          <th>Service</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
          <th>Scheduled</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      {% for b in bookings %}
        <tr data-status="{{ b.status }}">
          <td>
            <div class="user-info">
              <div class="user-avatar">{{ b.user.get_full_name|first|default:b.user.username|first|upper }}</div>
              <div class="user-name">{{ b.user.get_full_name|default:b.user.username }}</div>
            </div>
          </td>
          <td>{{ b.service.name }}</td>
          <td>{{ b.quantity }}</td>
          <td>${{ b.service.price|floatformat:2 }}</td>
          <td>${{ b.total_price|floatformat:2 }}</td>
          <td class="muted">{{ b.scheduled_date|date:"M d, Y H:i" }}</td>
          <td>
            {% if b.status == 'Pending' %}
              <span class="badge b-pending">Pending</span>
            {% elif b.status == 'Confirmed' %}
              <span class="badge b-confirmed">Confirmed</span>
            {% elif b.status == 'In Progress' %}
              <span class="badge b-confirmed">In Progress</span>
            {% elif b.status == 'Completed' %}
              <span class="badge b-completed">Completed</span>
            {% elif b.status == 'Cancelled' %}
              <span class="badge b-cancelled">Cancelled</span>
            {% else %}
              <span class="badge">{{ b.status }}</span>
            {% endif %}
          </td>
          <td>
            <div class="action-btns">
              <a href="{% url 'manage_service_bookings' %}?view={{ b.id }}" class="action-btn" title="View"><i class="fas fa-eye"></i></a>

              {% if b.status == 'Pending' %}
                <form method="post" action="{% url 'update_service_booking_status' b.id %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="Confirmed">
                  <button type="submit" class="action-btn success" onclick="return confirm('Confirm this booking?');" title="Confirm">
                    <i class="fas fa-check"></i>
                  </button>
                </form>
              {% endif %}

              {% if b.status == 'Confirmed' %}
                <form method="post" action="{% url 'update_service_booking_status' b.id %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="In Progress">
                  <button type="submit" class="action-btn info" onclick="return confirm('Mark as In Progress?');" title="In Progress">
                    <i class="fas fa-play"></i>
                  </button>
                </form>
              {% endif %}

              {% if b.status == 'In Progress' or b.status == 'Confirmed' %}
                <form method="post" action="{% url 'update_service_booking_status' b.id %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="Completed">
                  <button type="submit" class="action-btn" onclick="return confirm('Mark as Completed?');" title="Complete">
                    <i class="fas fa-check-double"></i>
                  </button>
                </form>
              {% endif %}

              {% if b.status != 'Cancelled' and b.status != 'Completed' %}
                <form method="post" action="{% url 'update_service_booking_status' b.id %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="status" value="Cancelled">
                  <button type="submit" class="action-btn danger" onclick="return confirm('Cancel this booking?');" title="Cancel">
                    <i class="fas fa-times"></i>
                  </button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
      <div class="empty">
        <div class="empty-icon"><i class="fas fa-concierge-bell"></i></div>
        <div class="empty-text">No service bookings found</div>
      </div>
    {% endif %}
  </div>
</div>

<script>
function filterTable() {
  const q = (document.getElementById('q')?.value || '').toLowerCase();
  const rows = document.querySelectorAll('#serviceBookingsTable tbody tr');
  rows.forEach(r => {
    const text = r.innerText.toLowerCase();
    r.style.display = text.includes(q) ? '' : 'none';
  });
}
</script>

{% endblock %}
