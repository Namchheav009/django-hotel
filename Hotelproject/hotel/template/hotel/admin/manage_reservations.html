{% extends 'hotel/admin/admin_base.html' %}
{% block title %}Manage Reservations - Admin Panel{% endblock %}

{% block admin_content %}
<div class="admin-content-title">
  <h1><i class="fas fa-calendar"></i> Reservation Management</h1>
</div>

<div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
  <!-- ✅ Go to page, NOT modal -->
  <a href="{% url 'add_reservation_page' %}" class="btn btn-primary">
    <i class="fas fa-plus"></i> New Reservation
  </a>
</div>

<!-- Filter Section -->
<div class="admin-card" style="margin-bottom: 20px;">
  <form method="GET" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <select name="status" class="form-select" style="max-width: 220px;">
      <option value="">All Statuses</option>
      {% for key,label in status_choices %}
        <option value="{{ key }}" {% if request.GET.status == key %}selected{% endif %}>{{ key }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary">Filter</button>
    {% if request.GET.status %}
      <a href="{% url 'manage_reservations' %}" class="btn btn-outline-secondary">Clear</a>
    {% endif %}
  </form>
</div>

<!-- Reservations Table -->
<div class="admin-card">
  {% if reservations %}
    <table class="admin-table">
      <thead>
        <tr>
          <th>Reservation ID</th>
          <th>Guest</th>
          <th>Room</th>
          <th>Check-in</th>
          <th>Check-out</th>
          <th>Status</th>
          <th>Total Price</th>
          <th style="min-width:360px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for reservation in reservations %}
          <tr>
            <td>#{{ reservation.id }}</td>

            <td>
              {{ reservation.guest.user.get_full_name|default:reservation.guest.user.username }}
            </td>

            <td class="text-muted">
              {{ reservation.room.room_number }} — {{ reservation.room.category.category_name }}
            </td>

            <td>{{ reservation.check_in_date|date:"M d, Y" }}</td>
            <td>{{ reservation.check_out_date|date:"M d, Y" }}</td>

            <td>
              {% if reservation.status == 'Pending' %}
                <span class="badge-pending">Pending</span>
              {% elif reservation.status == 'Confirmed' %}
                <span class="badge-confirmed">Confirmed</span>
              {% elif reservation.status == 'Checked In' %}
                <span class="badge-completed">Checked In</span>
              {% elif reservation.status == 'Checked Out' %}
                <span class="badge-completed">Checked Out</span>
              {% elif reservation.status == 'Cancelled' %}
                <span class="badge-cancelled">Cancelled</span>
              {% else %}
                <span class="badge-pending">{{ reservation.status }}</span>
              {% endif %}
            </td>

            <td>${{ reservation.total_price }}</td>

            <td>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">

                <a href="{% url 'edit_reservation' reservation.id %}" class="btn btn-sm btn-warning">
                  <i class="fas fa-edit"></i> Edit
                </a>

                <!-- Optional view (your guest view may block admin) -->
                <a href="{% url 'reservation_detail' reservation.id %}" class="btn btn-sm btn-info">
                  <i class="fas fa-eye"></i> View
                </a>

                <!-- ✅ Update Status (must match your view: request.POST.get('status')) -->
                <form method="POST" action="{% url 'update_reservation_status' reservation.id %}"
                      style="display:flex; gap:6px; align-items:center;">
                  {% csrf_token %}
                  <select name="status" class="form-select form-select-sm" style="width:auto;">
                    <option value="">Update Status</option>
                    <option value="Confirmed">Confirm</option>
                    <option value="Checked In">Check In</option>
                    <option value="Checked Out">Check Out</option>
                    <option value="Cancelled">Cancel</option>
                  </select>
                  <button type="submit" class="btn btn-sm btn-secondary">Update</button>
                </form>

                <form method="POST" action="{% url 'delete_reservation' reservation.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger"
                          onclick="return confirm('Delete reservation #{{ reservation.id }}?');">
                    Delete
                  </button>
                </form>

              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p style="color:#7f8c8d; text-align:center; padding:20px;">No reservations found.</p>
  {% endif %}
</div>

{% endblock %}
