{% extends 'hotel/admin/admin_base.html' %}

{% block title %}Dashboard - Admin Panel{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Hotel analytics overview{% endblock %}

{% block admin_content %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  .kpi-grid{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:14px;
    margin-bottom:16px;
  }

  .kpi{
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .kpi .icon{
    width:38px;height:38px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    background:#f1fff7;
    border:1px solid #c9f7da;
    color:#0f172a;
    font-weight:1000;
  }
  .kpi .label{ color:var(--muted); font-weight:900; font-size:12px; }
  .kpi .value{ font-weight:1000; font-size:20px; margin-top:2px; }
  .kpi .hint{ font-weight:900; font-size:12px; margin-top:2px; color:#16a34a; }

  .grid-2{
    display:grid;
    grid-template-columns: 1.35fr .65fr;
    gap:16px;
    align-items:start;
  }

  .card-title{
    font-weight:1000;
    margin:0;
    font-size:16px;
  }
  .card-sub{
    margin:4px 0 0;
    color:var(--muted);
    font-weight:800;
    font-size:13px;
  }

  .chart-wrap{ height:310px; }
  .chart-wrap canvas{ width:100% !important; height:100% !important; }

  .mini-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
    margin-top:16px;
  }

  .list{
    margin:12px 0 0;
    padding:0;
    list-style:none;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .list li{
    display:flex;
    align-items:flex-start;
    gap:10px;
    padding:10px;
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
  }
  .dot{ width:9px;height:9px;border-radius:999px; margin-top:6px; background:#22c55e; }
  .dot.blue{ background:#60a5fa; }
  .dot.orange{ background:#f59e0b; }
  .list strong{ font-weight:1000; }
  .list .small{ color:var(--muted); font-weight:800; font-size:13px; }

  @media (max-width: 1100px){
    .kpi-grid{ grid-template-columns: repeat(2, 1fr); }
    .grid-2{ grid-template-columns: 1fr; }
    .mini-grid{ grid-template-columns: 1fr; }
  }

  /* Topbar */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    margin-bottom:18px;
  }
  .top-left{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .page-title{
    font-weight:1000;
    margin:0;
    font-size:20px;
  }
  .page-sub{
    margin:0;
    font-weight:800;
    color:var(--muted);
    font-size:13px;
  }

  .top-actions{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .search{
    display:flex; align-items:center; gap:10px;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
    min-width:260px;
    box-shadow: 0 8px 20px rgba(11,18,32,.05);
  }
  .search i{ color:#98a2b3; }
  .search input{
    border:none; outline:none; width:100%;
    font-weight:800;
    color:var(--text);
  }

  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    font-weight:900;
    color:#111827;
    box-shadow: 0 8px 20px rgba(11,18,32,.05);
    text-decoration:none;
    cursor:pointer;
  }

  /* Notification */
  .notify-btn{ position:relative; }

  .notify-badge{
    position:absolute;
    top:6px;
    right:6px;
    background:#ef4444;
    color:#fff;
    font-size:10px;
    font-weight:1000;
    padding:2px 6px;
    border-radius:999px;
    line-height:1;
  }

  .notify-menu{
    width:340px;
    padding:0;
    border-radius:14px;
    overflow:hidden;
  }

  .notify-header{
    padding:12px 14px;
    font-weight:1000;
    border-bottom:1px solid var(--line);
    background:#f9fafb;
  }

  .notify-item{
    display:flex;
    gap:10px;
    padding:12px 14px;
    text-decoration:none;
    border-bottom:1px solid var(--line);
  }

  .notify-item:last-child{ border-bottom:none; }
  .notify-item:hover{ background:#f9fafb; }

  .notify-dot{
    width:9px;height:9px;border-radius:999px;margin-top:6px;background:#22c55e;
  }

  .notify-text{ font-weight:900; color:#111827; }
  .notify-sub{ font-size:12px; font-weight:800; color:var(--muted); }
</style>

<div class="topbar">
  <div class="top-left">
    <div>
      <h1 class="page-title">Dashboard</h1>
      <p class="page-sub">Overview of hotel performance</p>
    </div>
  </div>

  <div class="top-actions">
    <div class="search d-none d-md-flex">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="Search..." />
    </div>

    <!-- Notifications -->
    <div class="dropdown notify-btn">
      <button class="chip dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fa-regular fa-bell"></i>
        <span class="notify-badge">{{ total_notifications|default:"0" }}</span>
      </button>

      <ul class="dropdown-menu dropdown-menu-end notify-menu">
        <li class="notify-header">All Bookings ({{ total_notifications|default:"0" }})</li>

        {% if total_notifications == 0 %}
          <li class="text-center">
            <p style="padding:14px; color:var(--muted); font-weight:800; margin:0;">No bookings</p>
          </li>
        {% else %}
          <li class="text-center">
            <a href="{% url 'manage_bookings' %}" class="dropdown-item" style="font-weight:1000;">
              View all bookings →
            </a>
          </li>
        {% endif %}
      </ul>
    </div>

    <div class="dropdown">
      <button class="chip dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fa-regular fa-calendar"></i> Time period
      </button>
      <ul class="dropdown-menu dropdown-menu-end">
        <li><a class="dropdown-item" href="#">Today</a></li>
        <li><a class="dropdown-item" href="#">Last 7 days</a></li>
        <li><a class="dropdown-item" href="#">Last 30 days</a></li>
        <li><a class="dropdown-item" href="#">This year</a></li>
      </ul>
    </div>

    <a class="chip" href="{% url 'manage_reservations' %}">
      <i class="fa-solid fa-plus"></i> Add data
    </a>
  </div>
</div>

<!-- KPI cards -->
<div class="kpi-grid">
  <div class="admin-card kpi">
    <div class="icon"><i class="fa-solid fa-door-open"></i></div>
    <div>
      <div class="label">Total Rooms</div>
      <div class="value">{{ total_rooms|default:"0" }}</div>
      <div class="hint">+2.5%</div>
    </div>
  </div>

  <div class="admin-card kpi">
    <div class="icon" style="background:#eef7ff;border-color:#cfe7ff;">
      <i class="fa-solid fa-calendar-check"></i>
    </div>
    <div>
      <div class="label">Active Reservations</div>
      <div class="value">{{ active_reservations|default:"0" }}</div>
      <div class="hint" style="color:#2563eb;">+0.5%</div>
    </div>
  </div>

  <div class="admin-card kpi">
    <div class="icon" style="background:#fff7ed;border-color:#fed7aa;">
      <i class="fa-solid fa-users"></i>
    </div>
    <div>
      <div class="label">Guests Today</div>
      <div class="value">{{ guests_today|default:"0" }}</div>
      <div class="hint" style="color:#f59e0b;">+0.2%</div>
    </div>
  </div>

  <div class="admin-card kpi">
    <div class="icon" style="background:#fdf2f8;border-color:#fbcfe8;">
      <i class="fa-solid fa-dollar-sign"></i>
    </div>
    <div>
      <div class="label">Revenue (Today)</div>
      <div class="value">${{ revenue_today|default:"0" }}</div>
      <div class="hint" style="color:#db2777;">+1.2%</div>
    </div>
  </div>
</div>

<!-- Main charts -->
<div class="grid-2">
  <div class="admin-card">
    <div style="display:flex;justify-content:space-between;align-items:end;gap:12px;margin-bottom:10px;">
      <div>
        <div class="card-title">Reservation activity</div>
        <div class="card-sub">Bookings and revenue trend</div>
      </div>
      <span class="badge text-bg-light" style="border:1px solid var(--line);">Last days</span>
    </div>

    <div class="chart-wrap">
      <canvas id="barChart"></canvas>
    </div>
  </div>

  <div class="admin-card">
    <div class="card-title">Today’s Overview</div>
    <div class="card-sub">Important notes and tasks</div>

    <ul class="list">
      {% if today_activities %}
        {% for activity in today_activities %}
          <li>
            <div class="dot {% if activity.type == 'booking' %}blue{% elif activity.type == 'checkout' %}orange{% endif %}"></div>
            <div>
              <strong>{{ activity.title }}</strong>
              <div class="small">{{ activity.subtitle }}</div>
            </div>
          </li>
        {% endfor %}
      {% else %}
        <li>
          <div class="dot" style="background:#d1d5db;"></div>
          <div>
            <strong>No activities today</strong>
            <div class="small">All systems operating normally</div>
          </div>
        </li>
      {% endif %}
    </ul>

    <div style="margin-top:12px;display:flex;justify-content:center;">
      <a class="btn btn-outline-secondary" href="{% url 'manage_reservations' %}" style="border-radius:14px;font-weight:900;">
        View reservations
      </a>
    </div>
  </div>
</div>

<!-- Bottom cards -->
<div class="mini-grid">
  <div class="admin-card">
    <div style="display:flex;justify-content:space-between;align-items:end;gap:12px;margin-bottom:10px;">
      <div>
        <div class="card-title">Sales by room category</div>
        <div class="card-sub">Distribution</div>
      </div>
    </div>

    <div class="chart-wrap" style="height:260px;">
      <canvas id="donutChart"></canvas>
    </div>
  </div>

  <div class="admin-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div>
        <div class="card-title">Recent Reservations</div>
        <div class="card-sub">Latest activity</div>
      </div>
      <a href="{% url 'manage_reservations' %}" style="text-decoration:none;font-weight:1000;color:var(--muted);">View all →</a>
    </div>

    {% if recent_reservations %}
      <div class="table-responsive">
        <table class="table align-middle" style="margin:0;">
          <thead>
            <tr style="color:var(--muted); font-weight:1000; font-size:13px;">
              <th>Guest</th>
              <th>Room</th>
              <th>Check-in</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
          {% for r in recent_reservations %}
            <tr>
              <td style="font-weight:1000;">
                {{ r.guest.user.get_full_name|default:r.guest.user.username }}
              </td>
              <td class="text-muted" style="font-weight:900;">
                {{ r.room.room_number }} — {{ r.room.category.category_name }}
              </td>
              <td class="text-muted" style="font-weight:900;">
                {{ r.check_in_date|date:"M d" }}
              </td>
              <td>
                <span class="badge text-bg-light" style="border:1px solid var(--line);font-weight:1000;">
                  {{ r.status }}
                </span>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted" style="font-weight:900;padding:14px;border:1px dashed var(--line);border-radius:14px;">
        No reservations yet.
      </div>
    {% endif %}
  </div>
</div>

{# ===== SAFE JSON to JS (NO VSCode error) ===== #}
{{ chart_labels|json_script:"chart-labels" }}
{{ reservation_counts|json_script:"reservation-counts" }}
{{ revenue_by_day|json_script:"revenue-by-day" }}
{{ category_names|json_script:"category-names" }}
{{ category_counts|json_script:"category-counts" }}

<script>
  // ===== SAFE Notification Updates =====
  const notifyBadge = document.querySelector('.notify-badge');
  const notifyMenu  = document.querySelector('.notify-menu');

  const URL_ALL_BOOKINGS = "{% url 'api_all_bookings' %}";
  const URL_ROOM_MANAGE  = "{% url 'manage_reservations' %}";
  const URL_SERV_MANAGE  = "{% url 'manage_service_bookings' %}";
  const URL_ALL_MANAGE   = "{% url 'manage_bookings' %}";

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function fmtDate(d){
    if(!d) return "—";
    const dt = new Date(d);
    if (isNaN(dt.getTime())) return esc(d);
    return dt.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
  }

  function updateNotifications(){
    fetch(URL_ALL_BOOKINGS, { headers: { "Accept": "application/json" } })
      .then(r => {
        if(!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(data => {
        const total = Number(data?.total ?? 0);

        if (notifyBadge){
          notifyBadge.textContent = total;
          notifyBadge.style.display = total > 0 ? "inline-block" : "none";
        }

        if (!notifyMenu) return;

        const pendingRoom   = Array.isArray(data?.pending_room_bookings) ? data.pending_room_bookings : [];
        const pendingServ   = Array.isArray(data?.pending_service_bookings) ? data.pending_service_bookings : [];
        const confirmedRoom = Array.isArray(data?.confirmed_room_bookings) ? data.confirmed_room_bookings : [];
        const confirmedServ = Array.isArray(data?.confirmed_service_bookings) ? data.confirmed_service_bookings : [];

        const pendingTotal   = Number(data?.total_pending ?? (pendingRoom.length + pendingServ.length));
        const confirmedTotal = Number(data?.total_confirmed ?? (confirmedRoom.length + confirmedServ.length));

        let html = `<li class="notify-header">All Bookings (${total})</li>`;

        if (pendingTotal > 0){
          html += `<li style="padding:8px 14px; font-weight:800; font-size:12px; color:#ef4444; background:#fef2f2;">⚠️ PENDING BOOKINGS</li>`;

          pendingRoom.forEach(b => {
            const roomNo = esc(b?.room__room_number ?? "");
            const cat    = esc(b?.room__category__category_name ?? "");
            const guest  = esc(b?.guest_name ?? b?.guest__user__first_name ?? "Guest");
            html += `
              <li>
                <a href="${URL_ROOM_MANAGE}" class="notify-item">
                  <span class="notify-dot" style="background:#ef4444;"></span>
                  <div>
                    <div class="notify-text">Room ${roomNo} - ${guest}</div>
                    <div class="notify-sub">Check-in: ${fmtDate(b?.check_in_date)} · ${cat}</div>
                  </div>
                </a>
              </li>
            `;
          });

          pendingServ.forEach(b => {
            const service = esc(b?.service__name ?? "Service");
            const user    = esc(b?.user_name ?? b?.user__first_name ?? "User");
            html += `
              <li>
                <a href="${URL_SERV_MANAGE}" class="notify-item">
                  <span class="notify-dot" style="background:#f59e0b;"></span>
                  <div>
                    <div class="notify-text">${service} - ${user}</div>
                    <div class="notify-sub">Scheduled: ${fmtDate(b?.scheduled_date)}</div>
                  </div>
                </a>
              </li>
            `;
          });
        }

        if (confirmedTotal > 0){
          if (pendingTotal > 0){
            html += `<li style="border-bottom:1px solid var(--line); padding:4px 0; margin:4px 0;"></li>`;
          }
          html += `<li style="padding:8px 14px; font-weight:800; font-size:12px; color:#16a34a; background:#f0fdf4;">✓ CONFIRMED BOOKINGS</li>`;

          confirmedRoom.forEach(b => {
            const roomNo = esc(b?.room__room_number ?? "");
            const cat    = esc(b?.room__category__category_name ?? "");
            const guest  = esc(b?.guest_name ?? b?.guest__user__first_name ?? "Guest");
            html += `
              <li>
                <a href="${URL_ROOM_MANAGE}" class="notify-item">
                  <span class="notify-dot" style="background:#22c55e;"></span>
                  <div>
                    <div class="notify-text">Room ${roomNo} - ${guest}</div>
                    <div class="notify-sub">Check-in: ${fmtDate(b?.check_in_date)} · ${cat}</div>
                  </div>
                </a>
              </li>
            `;
          });

          confirmedServ.forEach(b => {
            const service = esc(b?.service__name ?? "Service");
            const user    = esc(b?.user_name ?? b?.user__first_name ?? "User");
            html += `
              <li>
                <a href="${URL_SERV_MANAGE}" class="notify-item">
                  <span class="notify-dot" style="background:#06b6d4;"></span>
                  <div>
                    <div class="notify-text">${service} - ${user}</div>
                    <div class="notify-sub">Scheduled: ${fmtDate(b?.scheduled_date)}</div>
                  </div>
                </a>
              </li>
            `;
          });
        }

        if (total === 0){
          html += `<li class="text-center"><p style="padding:14px; color:var(--muted); font-weight:800; margin:0;">No bookings</p></li>`;
        } else {
          html += `<li class="text-center"><a href="${URL_ALL_MANAGE}" class="dropdown-item" style="font-weight:1000;">View all bookings →</a></li>`;
        }

        notifyMenu.innerHTML = html;
      })
      .catch(err => console.warn("Failed to update notifications:", err));
  }

  updateNotifications();
  setInterval(updateNotifications, 30000);

  // ===== SAFE Chart Data (NO {% templatetag openvariable %}{% templatetag closevariable %} INSIDE JS) =====
  const chartLabels = JSON.parse(document.getElementById('chart-labels').textContent || "[]");
  const reservationCounts = JSON.parse(document.getElementById('reservation-counts').textContent || "[]");
  const revenueByDay = JSON.parse(document.getElementById('revenue-by-day').textContent || "[]");

  const categoryNames = JSON.parse(document.getElementById('category-names').textContent || "[]");
  const categoryCounts = JSON.parse(document.getElementById('category-counts').textContent || "[]");

  // ===== Bar chart =====
  const barCtx = document.getElementById('barChart');
  if (barCtx) {
    new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [
          { label: 'Reservations', data: reservationCounts, borderRadius: 10 },
          { label: 'Revenue', data: revenueByDay, borderRadius: 10 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#eef2f7' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // ===== Donut chart =====
  const donutCtx = document.getElementById('donutChart');
  if (donutCtx) {
    new Chart(donutCtx, {
      type: 'doughnut',
      data: {
        labels: categoryNames,
        datasets: [{
          data: categoryCounts,
          borderWidth: 2,
          hoverOffset: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { position: 'left' } }
      }
    });
  }
</script>

{% endblock %}
