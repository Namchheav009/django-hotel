{% extends 'hotel/admin/admin_base.html' %}
{% block title %}Manage Contacts - Admin Panel{% endblock %}

{% block admin_content %}
<div class="admin-content-title">
    <h1><i class="fas fa-envelope"></i> Contact Messages</h1>
</div>

<div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">New Contact</button>
</div>

<!-- Filter Section -->
<div class="admin-card" style="margin-bottom: 20px;">
    <form method="GET" style="display: flex; gap: 10px;">
        <select name="read_status" class="form-select" style="max-width: 200px;">
            <option value="">All Messages</option>
            <option value="unread" {% if request.GET.read_status == 'unread' %}selected{% endif %}>Unread</option>
            <option value="read" {% if request.GET.read_status == 'read' %}selected{% endif %}>Read</option>
        </select>
        <button type="submit" class="btn btn-primary">Filter</button>
    </form>
</div>

<!-- Messages Table -->
<div class="admin-card">
    {% if contacts %}
        <table class="admin-table">
            <thead>
                <tr>
                    <th>From</th>
                    <th>Email</th>
                    <th>Subject</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for contact in contacts %}
                    <tr style="{% if not contact.is_read %}font-weight: bold;{% endif %}">
                        <td>{{ contact.name }}</td>
                        <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                        <td>{{ contact.subject }}</td>
                        <td>{{ contact.created_at|date:"M d, Y H:i" }}</td>
                        <td>
                            {% if contact.is_read %}
                                <span class="badge badge-success">Read</span>
                            {% else %}
                                <span class="badge badge-warning">Unread</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewMessage({{ contact.id }}, '{{ contact.name }}', '{{ contact.email }}', '{{ contact.subject }}', `{{ contact.message }}`)">
                                <i class="fas fa-eye"></i> View
                            </button>
                            {% if not contact.is_read %}
                                <form method="POST" action="{% url 'mark_contact_read' contact.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-success">Mark Read</button>
                                </form>
                            {% endif %}
                            <a class="btn btn-sm btn-warning" href="{% url 'edit_contact' contact.id %}"><i class="fas fa-edit"></i> Edit</a>
                            <form method="post" action="{% url 'delete_contact' contact.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this message?')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="color: #7f8c8d; text-align: center; padding: 20px;">No contact messages found.</p>
    {% endif %}
</div>

<!-- View Message Modal -->
<div class="modal fade" id="viewMessageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageName"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>From:</strong> <span id="messageFrom"></span></p>
                <p><strong>Email:</strong> <span id="messageEmail"></span></p>
                <p><strong>Subject:</strong> <span id="messageSubject"></span></p>
                <hr>
                <p id="messageBody" style="white-space: pre-wrap;"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    function viewMessage(id, name, email, subject, message) {
        document.getElementById('messageName').textContent = name;
        document.getElementById('messageFrom').textContent = name;
        document.getElementById('messageEmail').textContent = email;
        document.getElementById('messageSubject').textContent = subject;
        document.getElementById('messageBody').textContent = message;
        new bootstrap.Modal(document.getElementById('viewMessageModal')).show();
    }
    
    function deleteMessage(contactId) {
        if (confirm('Are you sure you want to delete this message?')) {
            alert('Delete functionality - Contact ID: ' + contactId);
        }
    }
</script>
{% endblock %}


<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'add_contact' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input class="form-control" name="email" type="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject</label>
                        <input class="form-control" name="subject">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Contact</button>
                </div>
            </form>
        </div>
    </div>
</div>
